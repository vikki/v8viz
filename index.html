<html>
<head>
	<title>Yo!</title>
	<script src="components/underscore/underscore.js"></script>
</head>
<body>
<style>
  .thumb {
    height: 75px;
    border: 1px solid #000;
    margin: 10px 5px 0 0;
  }
</style>

<input type="file" id="files" name="files[]" multiple />
<output id="list"></output>

<script>

  function parseRanges(rangeStrArray){
     return rangeStrArray.map(
        function(bla){
          // named groups might help here??
          // also should prolly share the regex with the partitioner thingy
          var matches = bla.match(/(x|y\d?)range \[([\d.]+)\:([\d.]+)\]/);
          return {
             name: matches[1], 
             from: matches[2],
             to: matches[3]
          };
        });
  }


  function parseAxisLabels(labelStrArray){
     return labelStrArray.map(
        function(bla){
          // named groups might help here??
          // also should prolly share the regex with the partitioner thingy
          var matches = bla.match(/(x|y\d+)label "(.*)"/);
          return {
             axis: matches[1], 
             label: matches[2]
          };
        });
  }

    function parseLabels(labelStrArray){
     return labelStrArray.map(
        function(bla){
          // named groups might help here??
          // also should prolly share the regex with the partitioner thingy
          var matches = bla.match(/set label "([^"]*)" at ([\d.]+),([\d.]+) (textcolor rgb "([\w|#]+)")?/);
          return {
             label: matches[1],
             from: matches[2],
             to: matches[3],
             hexColor: matches[5],
          };
        });
  }

   // sweet jesus, rename when more awake
  function findPartsOfOutput(output){
      var lines = output.split('\n');

       // tmp global ofr messing about purposes
      out = _.chain(lines)
                 .reject(function(line) {
                   return line.match(/^((unset key)|(plot)|(set style)|(e)|$)/);
                  })
                 .groupBy(function(line) {
                  // OK the if statement is a little ropey but its still nicer than before.. 
                  if (line.match(/^set object/)) {
                    return 'objects';
                  } else if (line.match(/^set label/)) {
                    return 'labels';
                  } else if (line.match(/^set (x|y)\d?tics/)) {
                    return 'tics';
                  } else if (line.match(/^set (x|y)\d?range/)) {
                    return 'ranges';
                  } else if (line.match(/^set (x|y)\d?label/)) {
                    return 'axisLabels';
                  } else {
                    return 'dunno';
                  }
                }).value();

        // moar tmp globally goodness
        prettyRanges = parseRanges(out.ranges);
        prettyAxisLabels = parseAxisLabels(out.axisLabels);
        prettyLabels = parseLabels(out.labels);
  }



  function handleFileSelect(evt) {
    var files = evt.target.files; // FileList object

    // Loop through the FileList and render image files as thumbnails.
    for (var i = 0, f; f = files[i]; i++) {

      // Only process text files. - could warn instead and try to parse anyway?
      if (!f.type.match('text.*')) {
      	console.log('dude thats not a text file its a ' + f.type + ' file');
        continue;
      }

      var reader = new FileReader();

      reader.onload = (function(theFile) {
        return function(e) {
        	var contents = e.target.result;
        	//console.log(contents);
            findPartsOfOutput(contents);
        };
      })(f);

      // Read in the image file as a data URL.
      reader.readAsText(f);
    }
  }

  document.getElementById('files').addEventListener('change', handleFileSelect, false);
</script>

</body>
</html>
